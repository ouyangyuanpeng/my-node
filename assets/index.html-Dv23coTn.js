import{_ as i,c as a,a as t,o as e}from"./app-CbO9e9FJ.js";const n={};function l(r,s){return e(),a("div",null,s[0]||(s[0]=[t(`<h2 id="临时表" tabindex="-1"><a class="header-anchor" href="#临时表"><span>临时表</span></a></h2><p>在 MySQL 中，​<strong>临时表（Temporary Table）​</strong>  是数据库在执行复杂查询或操作时自动创建的中间表，用于存储临时计算结果。</p><h4 id="_1-​排序-order-by-​" tabindex="-1"><a class="header-anchor" href="#_1-​排序-order-by-​"><span>1. ​<strong>排序（ORDER BY）​</strong></span></a></h4><ul><li>​<strong>场景</strong>：当对未索引的字段进行排序时，MySQL 需要将结果集放入临时表再排序。</li><li>​<strong>示例</strong>：<div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">ORDER BY</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> last_login_time </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">DESC</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li>​<strong>触发条件</strong>：<code>Using filesort</code>（执行计划中可见）。</li></ul><h4 id="_2-​分组-group-by-​" tabindex="-1"><a class="header-anchor" href="#_2-​分组-group-by-​"><span>2. ​<strong>分组（GROUP BY）​</strong></span></a></h4><ul><li><p>​<strong>场景</strong>：对未索引的字段分组统计时，需将中间结果存入临时表。</p></li><li><p>​<strong>示例</strong>：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> department_id, </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">COUNT</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">) </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> employees </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">GROUP BY</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> department_id;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>​<strong>触发条件</strong>：<code>Using temporary</code>（执行计划中可见）。</p></li></ul><h4 id="_3-​连接-join-​" tabindex="-1"><a class="header-anchor" href="#_3-​连接-join-​"><span>3. ​<strong>连接（JOIN）​</strong></span></a></h4><ul><li><p>​<strong>场景</strong>：多表 JOIN 时，如果驱动表无法高效匹配被驱动表，可能生成中间临时表。</p></li><li><p>​<strong>示例</strong>：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> orders</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">JOIN</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> customers </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">ON</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> orders</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">.</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">customer_id</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> customers</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">.</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">id</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> customers</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">.</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">country</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">US</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="_4-​子查询-subquery-​" tabindex="-1"><a class="header-anchor" href="#_4-​子查询-subquery-​"><span>4. ​<strong>子查询（Subquery）​</strong></span></a></h4><ul><li><p>​<strong>场景</strong>：子查询结果需要被外部查询多次引用时，可能物化为临时表。</p></li><li><p>​<strong>示例</strong>：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> products</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> price </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> AVG</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(price) </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> products);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="_5-​union-操作" tabindex="-1"><a class="header-anchor" href="#_5-​union-操作"><span>5. ​<strong>UNION 操作</strong></span></a></h4><ul><li><p>​<strong>场景</strong>：<code>UNION</code>  需要合并多个结果集并去重，必须通过临时表实现。</p></li><li><p>​<strong>示例</strong>：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> name</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> employees</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">UNION</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> name</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> contractors;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="_6-​大结果集处理" tabindex="-1"><a class="header-anchor" href="#_6-​大结果集处理"><span>6. ​<strong>大结果集处理</strong></span></a></h4><ul><li><p>​<strong>场景</strong>：内存不足以存储中间结果时，临时表会被写入磁盘（如  <code>Using temporary; Using filesort</code>）。</p></li><li><p>​<strong>示例</strong>：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> logs </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> create_time </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">2023-01-01</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">ORDER BY</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ip_address;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="_7-​会话级中间数据" tabindex="-1"><a class="header-anchor" href="#_7-​会话级中间数据"><span>7. ​<strong>会话级中间数据</strong></span></a></h4><ul><li>​<strong>场景</strong>：显式创建临时表存储会话级中间数据（如复杂计算中间结果）。</li><li>​<strong>示例</strong>： sql<div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">CREATE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> TEMPORARY </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">TABLE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> temp_orders</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> user_id, </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">SUM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(amount) </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> orders </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">GROUP BY</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> user_id;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="二、如何识别临时表使用" tabindex="-1"><a class="header-anchor" href="#二、如何识别临时表使用"><span>二、如何识别临时表使用</span></a></h3><ol><li><p>​<strong>执行计划（EXPLAIN）​</strong>：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ...;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><ul><li>关注  <code>Extra</code>  列中的  <code>Using temporary</code>  和  <code>Using filesort</code>。</li></ul><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>排序/分组</td><td>减少临时表生成</td><td>添加索引、调整内存参数</td></tr><tr><td>大结果集处理</td><td>避免磁盘临时表</td><td>拆分查询、限制结果集大小</td></tr><tr><td>复杂 JOIN/子查询</td><td>降低计算复杂度</td><td>重写查询、使用物化视图</td></tr><tr><td>高并发场景</td><td>避免临时表竞争</td><td>会话级临时表、分布式架构</td></tr></tbody></table><p>通过分析执行计划、监控临时表使用频率，结合索引优化和查询重构，可显著减少临时表带来的性能问题。</p><ol><li><strong>优化索引</strong>：确保所有 WHERE 条件和 JOIN 字段上有合适的索引，特别是 user_no 和 create_time 的组合索引，以及 type、self_asses_id 等字段的索引。</li><li>​<strong>增加临时表内存设置</strong>：调整 tmp_table_size 和 max_heap_table_size，让更多的临时表保留在内存中，减少磁盘使用。</li><li>​<strong>简化查询</strong>：考虑是否可以将部分子查询合并，或者将一些计算逻辑移到应用层，减少数据库的负担。</li><li>​<strong>分批查询</strong>：将 IN 列表中的用户分成多个小组，每次查询部分用户的数据，最后在应用层汇总结果。</li><li>​<strong>清理和监控临时目录</strong>：定期清理/tmp 目录，确保有足够的空间，并考虑将 MySQL 的临时目录指向一个更大容量的磁盘分区。</li><li>​<strong>分析执行计划</strong>：使用 EXPLAIN 分析 SQL 语句的执行计划，查看是否有全表扫描、临时表使用情况，从而针对性优化。</li></ol><h3 id="问题根源分析" tabindex="-1"><a class="header-anchor" href="#问题根源分析"><span>问题根源分析</span></a></h3><p>uncategorized SQLException; SQL state [HY000]; error code [3]; Error writing file &#39;/tmp/MYgrztRa&#39;</p><p>该错误由以下两个因素共同导致：</p><ol><li>​<strong>磁盘空间不足</strong>：<code>/tmp</code>目录所在分区空间耗尽。</li><li>​<strong>查询生成超大临时文件</strong>：多表JOIN、大量IN子句、未优化的GROUP BY操作导致MySQL需要生成超大临时表。</li></ol>`,26)]))}const d=i(n,[["render",l],["__file","index.html.vue"]]),p=JSON.parse('{"path":"/%E6%95%B0%E6%8D%AE%E5%BA%93/u34i2wcc/","title":"Mysql优化","lang":"zh-CN","frontmatter":{"title":"Mysql优化","createTime":"2025/04/01 14:23:52","permalink":"/数据库/u34i2wcc/"},"headers":[],"readingTime":{"minutes":3.03,"words":910},"git":{"updatedTime":1743517415000,"contributors":[{"name":"oyyp","email":"513150165@qq.com","commits":1,"avatar":"https://avatars.githubusercontent.com/oyyp?v=4","url":"https://github.com/oyyp"}]},"filePathRelative":"notes/数据库/Mysql/Mysql优化.md","categoryList":[{"id":"4358b5","sort":10000,"name":"notes"},{"id":"324a5c","sort":10001,"name":"数据库"},{"id":"3aab05","sort":10002,"name":"Mysql"}],"bulletin":false}');export{d as comp,p as data};
